name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-quality:
    name: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "Dependencies installed successfully"

      - name: Run ESLint
        id: eslint
        run: |
          echo "Running ESLint checks..."
          npm run lint > eslint-output.txt 2>&1 || {
            echo "eslint_status=failed" >> $GITHUB_OUTPUT
            cat eslint-output.txt
            exit 0
          }
          echo "eslint_status=passed" >> $GITHUB_OUTPUT
          cat eslint-output.txt
        continue-on-error: true

      - name: Run Prettier check
        id: prettier
        run: |
          echo "Running Prettier formatting checks..."
          npx prettier --check "src/**/*.js" "tests/**/*.js" "*.js" > prettier-output.txt 2>&1 || {
            echo "prettier_status=failed" >> $GITHUB_OUTPUT
            cat prettier-output.txt
            exit 0
          }
          echo "prettier_status=passed" >> $GITHUB_OUTPUT
          echo "All files are properly formatted" > prettier-output.txt
        continue-on-error: true

      - name: Read ESLint output
        id: eslint-output
        if: always()
        run: |
          if [ -f eslint-output.txt ]; then
            echo 'ESLINT_OUTPUT<<EOF' >> $GITHUB_ENV
            cat eslint-output.txt >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
          else
            echo 'ESLINT_OUTPUT=No output available' >> $GITHUB_ENV
          fi

      - name: Read Prettier output
        id: prettier-output
        if: always()
        run: |
          if [ -f prettier-output.txt ]; then
            echo 'PRETTIER_OUTPUT<<EOF' >> $GITHUB_ENV
            cat prettier-output.txt >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
          else
            echo 'PRETTIER_OUTPUT=No output available' >> $GITHUB_ENV
          fi

      - name: Post Code Quality Report
        if: always()
        uses: actions/github-script@v7
        env:
          ESLINT_STATUS: ${{ steps.eslint.outputs.eslint_status }}
          PRETTIER_STATUS: ${{ steps.prettier.outputs.prettier_status }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const eslintStatus = process.env.ESLINT_STATUS || 'unknown';
            const prettierStatus = process.env.PRETTIER_STATUS || 'unknown';
            const eslintOutput = process.env.ESLINT_OUTPUT || 'No output';
            const prettierOutput = process.env.PRETTIER_OUTPUT || 'No output';
            
            const getStatusEmoji = (status) => {
              if (status === 'passed') return '‚úÖ';
              if (status === 'failed') return '‚ùå';
              return '‚ùì';
            };
            
            const overallStatus = (eslintStatus === 'passed' && prettierStatus === 'passed') ? '‚úÖ PASSED' : '‚ùå FAILED';
            
            const body = `## üìã Code Quality Report

**Overall Status:** ${overallStatus}

### ESLint Results ${getStatusEmoji(eslintStatus)}
**Status:** ${eslintStatus.toUpperCase()}

<details>
<summary>View ESLint Output</summary>

\`\`\`
${eslintOutput.substring(0, 10000)}
\`\`\`

</details>

### Prettier Results ${getStatusEmoji(prettierStatus)}
**Status:** ${prettierStatus.toUpperCase()}

<details>
<summary>View Prettier Output</summary>

\`\`\`
${prettierOutput.substring(0, 10000)}
\`\`\`

</details>

---
*Report generated by PR Automation Workflow*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Code Quality Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if quality checks failed
        if: steps.eslint.outputs.eslint_status == 'failed' || steps.prettier.outputs.prettier_status == 'failed'
        run: |
          echo "Code quality checks failed. Please fix the issues before merging."
          exit 1

  testing-suite:
    name: testing-suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "Dependencies installed successfully"

      - name: Run test suite
        id: test
        run: |
          echo "Running full test suite..."
          npm test 2>&1 | tee test-output.txt || {
            echo "test_status=failed" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "test_status=passed" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate test coverage report
        id: coverage
        run: |
          echo "Generating test coverage report..."
          npm run test:coverage 2>&1 | tee coverage-output.txt || {
            echo "coverage_status=failed" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "coverage_status=passed" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse coverage data
        id: parse-coverage
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "Coverage summary found"
            cat coverage/coverage-summary.json
            # Extract coverage percentages using jq if available, otherwise use grep
            if command -v jq &> /dev/null; then
              LINES=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
              STATEMENTS=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
              FUNCTIONS=$(jq -r '.total.functions.pct' coverage/coverage-summary.json)
              BRANCHES=$(jq -r '.total.branches.pct' coverage/coverage-summary.json)
            else
              LINES="N/A"
              STATEMENTS="N/A"
              FUNCTIONS="N/A"
              BRANCHES="N/A"
            fi
            echo "lines_coverage=$LINES" >> $GITHUB_OUTPUT
            echo "statements_coverage=$STATEMENTS" >> $GITHUB_OUTPUT
            echo "functions_coverage=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "branches_coverage=$BRANCHES" >> $GITHUB_OUTPUT
          else
            echo "lines_coverage=N/A" >> $GITHUB_OUTPUT
            echo "statements_coverage=N/A" >> $GITHUB_OUTPUT
            echo "functions_coverage=N/A" >> $GITHUB_OUTPUT
            echo "branches_coverage=N/A" >> $GITHUB_OUTPUT
          fi

      - name: Read test output
        id: test-output
        if: always()
        run: |
          if [ -f test-output.txt ]; then
            echo 'TEST_OUTPUT<<EOF' >> $GITHUB_ENV
            cat test-output.txt >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
          else
            echo 'TEST_OUTPUT=No test output available' >> $GITHUB_ENV
          fi

      - name: Upload coverage artifacts
        if: always() && hashFiles('coverage/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Post Test Coverage Report
        if: always()
        uses: actions/github-script@v7
        env:
          TEST_STATUS: ${{ steps.test.outputs.test_status }}
          COVERAGE_STATUS: ${{ steps.coverage.outputs.coverage_status }}
          LINES_COV: ${{ steps.parse-coverage.outputs.lines_coverage }}
          STATEMENTS_COV: ${{ steps.parse-coverage.outputs.statements_coverage }}
          FUNCTIONS_COV: ${{ steps.parse-coverage.outputs.functions_coverage }}
          BRANCHES_COV: ${{ steps.parse-coverage.outputs.branches_coverage }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testStatus = process.env.TEST_STATUS || 'unknown';
            const coverageStatus = process.env.COVERAGE_STATUS || 'unknown';
            const testOutput = process.env.TEST_OUTPUT || 'No output';
            
            const linesCov = process.env.LINES_COV || 'N/A';
            const statementsCov = process.env.STATEMENTS_COV || 'N/A';
            const functionsCov = process.env.FUNCTIONS_COV || 'N/A';
            const branchesCov = process.env.BRANCHES_COV || 'N/A';
            
            const getStatusEmoji = (status) => {
              if (status === 'passed') return '‚úÖ';
              if (status === 'failed') return '‚ùå';
              return '‚ùì';
            };
            
            const getCoverageEmoji = (cov) => {
              if (cov === 'N/A') return '‚ùì';
              const pct = parseFloat(cov);
              if (pct >= 80) return '‚úÖ';
              if (pct >= 70) return '‚ö†Ô∏è';
              return '‚ùå';
            };
            
            const overallStatus = (testStatus === 'passed' && coverageStatus === 'passed') ? '‚úÖ PASSED' : '‚ùå FAILED';
            
            const body = `## üß™ Test Coverage Report

**Overall Status:** ${overallStatus}

### Test Suite Results ${getStatusEmoji(testStatus)}
**Status:** ${testStatus.toUpperCase()}

<details>
<summary>View Test Output</summary>

\`\`\`
${testOutput.substring(0, 10000)}
\`\`\`

</details>

### Coverage Summary ${getStatusEmoji(coverageStatus)}

| Metric | Coverage | Status |
|--------|----------|--------|
| Lines | ${linesCov}% | ${getCoverageEmoji(linesCov)} |
| Statements | ${statementsCov}% | ${getCoverageEmoji(statementsCov)} |
| Functions | ${functionsCov}% | ${getCoverageEmoji(functionsCov)} |
| Branches | ${branchesCov}% | ${getCoverageEmoji(branchesCov)} |

**Threshold:** 70% (minimum for all metrics)

---
*Report generated by PR Automation Workflow*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Test Coverage Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if tests failed
        if: steps.test.outputs.test_status == 'failed' || steps.coverage.outputs.coverage_status == 'failed'
        run: |
          echo "Tests or coverage generation failed. Please fix the issues before merging."
          exit 1

  security-scan:
    name: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "Dependencies installed successfully"

      - name: Run npm audit
        id: npm-audit
        run: |
          echo "Running dependency vulnerability checks..."
          npm audit --json > npm-audit.json 2>&1 || true
          if [ -f npm-audit.json ]; then
            VULNERABILITIES=$(cat npm-audit.json | grep -o '"vulnerabilities"' | wc -l)
            if [ "$VULNERABILITIES" -gt 0 ]; then
              echo "audit_status=vulnerabilities_found" >> $GITHUB_OUTPUT
            else
              echo "audit_status=passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "audit_status=unknown" >> $GITHUB_OUTPUT
          fi
          npm audit 2>&1 | tee npm-audit-output.txt || true
        continue-on-error: true

      - name: Scan for secrets
        id: secret-scan
        run: |
          echo "Scanning for secrets in code changes..."
          # Using a lightweight secret detection approach
          echo "Searching for potential secrets in committed files..."
          
          # Check for common secret patterns
          SECRETS_FOUND=0
          
          # Search for API keys, tokens, passwords
          if git diff --name-only HEAD~1 2>/dev/null; then
            FILES=$(git diff --name-only HEAD~1 2>/dev/null || echo "")
          else
            FILES=$(find . -type f -name "*.js" -o -name "*.json" -o -name "*.env*" 2>/dev/null || echo "")
          fi
          
          if [ ! -z "$FILES" ]; then
            echo "Scanning files: $FILES"
            for file in $FILES; do
              if [ -f "$file" ]; then
                # Look for common secret patterns
                if grep -iE '(api[_-]?key|secret[_-]?key|password|token|auth[_-]?token|private[_-]?key).*[=:].*["\x27][a-zA-Z0-9]{20,}' "$file" 2>/dev/null; then
                  SECRETS_FOUND=$((SECRETS_FOUND + 1))
                  echo "Potential secret found in: $file"
                fi
              fi
            done
          fi
          
          if [ $SECRETS_FOUND -gt 0 ]; then
            echo "secret_scan_status=secrets_found" >> $GITHUB_OUTPUT
            echo "secrets_count=$SECRETS_FOUND" >> $GITHUB_OUTPUT
          else
            echo "secret_scan_status=passed" >> $GITHUB_OUTPUT
            echo "secrets_count=0" >> $GITHUB_OUTPUT
          fi
          echo "Secret scan completed. Potential secrets found: $SECRETS_FOUND" > secret-scan-output.txt
        continue-on-error: true

      - name: Parse npm audit results
        id: parse-audit
        if: always()
        run: |
          if [ -f npm-audit.json ]; then
            # Try to extract vulnerability counts
            if command -v jq &> /dev/null && jq -e . npm-audit.json >/dev/null 2>&1; then
              CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' npm-audit.json 2>/dev/null || echo "0")
              HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' npm-audit.json 2>/dev/null || echo "0")
              MODERATE=$(jq -r '.metadata.vulnerabilities.moderate // 0' npm-audit.json 2>/dev/null || echo "0")
              LOW=$(jq -r '.metadata.vulnerabilities.low // 0' npm-audit.json 2>/dev/null || echo "0")
              TOTAL=$(jq -r '.metadata.vulnerabilities.total // 0' npm-audit.json 2>/dev/null || echo "0")
            else
              CRITICAL="0"
              HIGH="0"
              MODERATE="0"
              LOW="0"
              TOTAL="0"
            fi
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "moderate=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
          fi

      - name: Read audit output
        id: audit-output
        if: always()
        run: |
          if [ -f npm-audit-output.txt ]; then
            echo 'AUDIT_OUTPUT<<EOF' >> $GITHUB_ENV
            cat npm-audit-output.txt >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
          else
            echo 'AUDIT_OUTPUT=No audit output available' >> $GITHUB_ENV
          fi

      - name: Read secret scan output
        id: secret-output
        if: always()
        run: |
          if [ -f secret-scan-output.txt ]; then
            echo 'SECRET_OUTPUT<<EOF' >> $GITHUB_ENV
            cat secret-scan-output.txt >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
          else
            echo 'SECRET_OUTPUT=No secret scan output available' >> $GITHUB_ENV
          fi

      - name: Post Security Scan Report
        if: always()
        uses: actions/github-script@v7
        env:
          AUDIT_STATUS: ${{ steps.npm-audit.outputs.audit_status }}
          SECRET_STATUS: ${{ steps.secret-scan.outputs.secret_scan_status }}
          SECRETS_COUNT: ${{ steps.secret-scan.outputs.secrets_count }}
          CRITICAL: ${{ steps.parse-audit.outputs.critical }}
          HIGH: ${{ steps.parse-audit.outputs.high }}
          MODERATE: ${{ steps.parse-audit.outputs.moderate }}
          LOW: ${{ steps.parse-audit.outputs.low }}
          TOTAL: ${{ steps.parse-audit.outputs.total }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const auditStatus = process.env.AUDIT_STATUS || 'unknown';
            const secretStatus = process.env.SECRET_STATUS || 'unknown';
            const secretsCount = process.env.SECRETS_COUNT || '0';
            const auditOutput = process.env.AUDIT_OUTPUT || 'No output';
            const secretOutput = process.env.SECRET_OUTPUT || 'No output';
            
            const critical = process.env.CRITICAL || '0';
            const high = process.env.HIGH || '0';
            const moderate = process.env.MODERATE || '0';
            const low = process.env.LOW || '0';
            const total = process.env.TOTAL || '0';
            
            const getStatusEmoji = (status) => {
              if (status === 'passed') return '‚úÖ';
              if (status === 'vulnerabilities_found' || status === 'secrets_found') return '‚ö†Ô∏è';
              return '‚ùì';
            };
            
            const overallStatus = (auditStatus === 'passed' && secretStatus === 'passed') ? '‚úÖ PASSED' : '‚ö†Ô∏è ISSUES FOUND';
            
            const body = `## üîí Security Scan Report

**Overall Status:** ${overallStatus}

### Dependency Vulnerabilities ${getStatusEmoji(auditStatus)}
**Status:** ${auditStatus.toUpperCase().replace('_', ' ')}

#### Vulnerability Summary
| Severity | Count |
|----------|-------|
| üî¥ Critical | ${critical} |
| üü† High | ${high} |
| üü° Moderate | ${moderate} |
| üü¢ Low | ${low} |
| **Total** | **${total}** |

<details>
<summary>View Dependencies Audit Output</summary>

\`\`\`
${auditOutput.substring(0, 8000)}
\`\`\`

</details>

### Secret Scanning ${getStatusEmoji(secretStatus)}
**Status:** ${secretStatus.toUpperCase().replace('_', ' ')}
**Potential Secrets Found:** ${secretsCount}

<details>
<summary>View Secret Scan Output</summary>

\`\`\`
${secretOutput.substring(0, 5000)}
\`\`\`

</details>

${parseInt(critical) > 0 || parseInt(high) > 0 ? '‚ö†Ô∏è **Warning:** Critical or high severity vulnerabilities detected. Please review and update dependencies.' : ''}
${parseInt(secretsCount) > 0 ? '‚ö†Ô∏è **Warning:** Potential secrets detected in code. Please review and remove sensitive data.' : ''}

---
*Report generated by PR Automation Workflow*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Security Scan Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check for critical vulnerabilities
        if: always()
        run: |
          CRITICAL=${{ steps.parse-audit.outputs.critical }}
          HIGH=${{ steps.parse-audit.outputs.high }}
          
          if [ "$CRITICAL" != "0" ] || [ "$HIGH" != "0" ]; then
            echo "‚ö†Ô∏è Warning: Critical or high severity vulnerabilities found!"
            echo "Critical: $CRITICAL, High: $HIGH"
            echo "Please review and update vulnerable dependencies."
            # Don't fail the job, just warn
          fi
          echo "Security scan completed successfully"

  build-validation:
    name: build-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "Dependencies installed successfully"

      - name: Build application
        id: build
        run: |
          echo "Building application..."
          npm run build 2>&1 | tee build-output.txt || {
            echo "build_status=failed" >> $GITHUB_OUTPUT
            exit 0
          }
          echo "build_status=passed" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Start application for endpoint validation
        id: start-app
        run: |
          echo "Starting application for endpoint validation..."
          npm start &
          APP_PID=$!
          echo "app_pid=$APP_PID" >> $GITHUB_OUTPUT
          
          # Wait for application to start
          echo "Waiting for application to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:3000/health 2>/dev/null; then
              echo "Application is ready!"
              echo "app_started=true" >> $GITHUB_OUTPUT
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          if [ "$i" -eq 30 ]; then
            echo "app_started=false" >> $GITHUB_OUTPUT
            echo "Application failed to start in time"
          fi
        continue-on-error: true

      - name: Validate endpoints
        id: validate
        if: steps.start-app.outputs.app_started == 'true'
        run: |
          echo "Validating application endpoints..."
          
          # Test health endpoint
          echo "Testing /health endpoint..."
          if curl -f http://localhost:3000/health; then
            echo "‚úÖ Health endpoint is accessible"
            HEALTH_STATUS="passed"
          else
            echo "‚ùå Health endpoint failed"
            HEALTH_STATUS="failed"
          fi
          
          # Test root endpoint
          echo "Testing / endpoint..."
          if curl -f http://localhost:3000/; then
            echo "‚úÖ Root endpoint is accessible"
            ROOT_STATUS="passed"
          else
            echo "‚ùå Root endpoint failed"
            ROOT_STATUS="failed"
          fi
          
          # Test 404 handling
          echo "Testing 404 handling..."
          if curl http://localhost:3000/nonexistent 2>&1 | grep -q "404"; then
            echo "‚úÖ 404 handling works correctly"
            NOT_FOUND_STATUS="passed"
          else
            echo "‚ö†Ô∏è 404 handling may have issues"
            NOT_FOUND_STATUS="warning"
          fi
          
          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          echo "root_status=$ROOT_STATUS" >> $GITHUB_OUTPUT
          echo "not_found_status=$NOT_FOUND_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$HEALTH_STATUS" = "passed" ] && [ "$ROOT_STATUS" = "passed" ]; then
            echo "validation_status=passed" >> $GITHUB_OUTPUT
          else
            echo "validation_status=failed" >> $GITHUB_OUTPUT
          fi
          
          # Save validation results
          echo "Endpoint Validation Results:" > validation-output.txt
          echo "Health endpoint: $HEALTH_STATUS" >> validation-output.txt
          echo "Root endpoint: $ROOT_STATUS" >> validation-output.txt
          echo "404 handling: $NOT_FOUND_STATUS" >> validation-output.txt
        continue-on-error: true

      - name: Stop application
        if: always() && steps.start-app.outputs.app_pid != ''
        run: |
          APP_PID=${{ steps.start-app.outputs.app_pid }}
          if [ ! -z "$APP_PID" ]; then
            echo "Stopping application (PID: $APP_PID)..."
            kill $APP_PID 2>/dev/null || true
            sleep 2
            kill -9 $APP_PID 2>/dev/null || true
          fi

      - name: Create deployment preview artifacts
        id: artifacts
        if: always()
        run: |
          echo "Creating deployment preview artifacts..."
          mkdir -p deployment-preview
          
          # Copy relevant files
          cp -r src deployment-preview/ 2>/dev/null || true
          cp package.json deployment-preview/ 2>/dev/null || true
          cp package-lock.json deployment-preview/ 2>/dev/null || true
          
          # Create deployment info
          cat > deployment-preview/deployment-info.txt << EOF
          Deployment Preview Information
          ===============================
          Branch: ${{ github.head_ref }}
          Commit: ${{ github.sha }}
          PR Number: ${{ github.event.pull_request.number }}
          Created: $(date)
          Node Version: 18
          EOF
          
          echo "artifacts_created=true" >> $GITHUB_OUTPUT

      - name: Upload deployment preview artifacts
        if: always() && steps.artifacts.outputs.artifacts_created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-preview
          path: deployment-preview/
          retention-days: 14

      - name: Read build output
        id: build-output-read
        if: always()
        run: |
          if [ -f build-output.txt ]; then
            echo 'BUILD_OUTPUT<<EOF' >> $GITHUB_ENV
            cat build-output.txt >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
          else
            echo 'BUILD_OUTPUT=No build output available' >> $GITHUB_ENV
          fi

      - name: Read validation output
        id: validation-output-read
        if: always()
        run: |
          if [ -f validation-output.txt ]; then
            echo 'VALIDATION_OUTPUT<<EOF' >> $GITHUB_ENV
            cat validation-output.txt >> $GITHUB_ENV
            echo 'EOF' >> $GITHUB_ENV
          else
            echo 'VALIDATION_OUTPUT=No validation output available' >> $GITHUB_ENV
          fi

      - name: Post Build Validation Report
        if: always()
        uses: actions/github-script@v7
        env:
          BUILD_STATUS: ${{ steps.build.outputs.build_status }}
          APP_STARTED: ${{ steps.start-app.outputs.app_started }}
          VALIDATION_STATUS: ${{ steps.validate.outputs.validation_status }}
          HEALTH_STATUS: ${{ steps.validate.outputs.health_status }}
          ROOT_STATUS: ${{ steps.validate.outputs.root_status }}
          NOT_FOUND_STATUS: ${{ steps.validate.outputs.not_found_status }}
          ARTIFACTS_CREATED: ${{ steps.artifacts.outputs.artifacts_created }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const buildStatus = process.env.BUILD_STATUS || 'unknown';
            const appStarted = process.env.APP_STARTED || 'false';
            const validationStatus = process.env.VALIDATION_STATUS || 'unknown';
            const healthStatus = process.env.HEALTH_STATUS || 'unknown';
            const rootStatus = process.env.ROOT_STATUS || 'unknown';
            const notFoundStatus = process.env.NOT_FOUND_STATUS || 'unknown';
            const artifactsCreated = process.env.ARTIFACTS_CREATED || 'false';
            const buildOutput = process.env.BUILD_OUTPUT || 'No output';
            const validationOutput = process.env.VALIDATION_OUTPUT || 'No output';
            
            const getStatusEmoji = (status) => {
              if (status === 'passed' || status === 'true') return '‚úÖ';
              if (status === 'failed' || status === 'false') return '‚ùå';
              if (status === 'warning') return '‚ö†Ô∏è';
              return '‚ùì';
            };
            
            const overallStatus = (buildStatus === 'passed' && validationStatus === 'passed') ? '‚úÖ PASSED' : 
                                  (buildStatus === 'failed') ? '‚ùå BUILD FAILED' : 
                                  '‚ö†Ô∏è VALIDATION ISSUES';
            
            const body = `## üèóÔ∏è Build Validation Report

**Overall Status:** ${overallStatus}

### Build Status ${getStatusEmoji(buildStatus)}
**Status:** ${buildStatus.toUpperCase()}

<details>
<summary>View Build Output</summary>

\`\`\`
${buildOutput.substring(0, 8000)}
\`\`\`

</details>

### Application Startup ${getStatusEmoji(appStarted)}
**Status:** ${appStarted === 'true' ? 'STARTED SUCCESSFULLY' : 'FAILED TO START'}

### Endpoint Validation ${getStatusEmoji(validationStatus)}
**Status:** ${validationStatus.toUpperCase()}

| Endpoint | Status |
|----------|--------|
| /health | ${getStatusEmoji(healthStatus)} ${healthStatus.toUpperCase()} |
| / (root) | ${getStatusEmoji(rootStatus)} ${rootStatus.toUpperCase()} |
| 404 Handling | ${getStatusEmoji(notFoundStatus)} ${notFoundStatus.toUpperCase()} |

<details>
<summary>View Validation Output</summary>

\`\`\`
${validationOutput}
\`\`\`

</details>

### Deployment Preview ${getStatusEmoji(artifactsCreated)}
**Artifacts Created:** ${artifactsCreated === 'true' ? 'YES' : 'NO'}

${artifactsCreated === 'true' ? 'üì¶ Deployment preview artifacts are available for download in the Actions artifacts.' : ''}

---
*Report generated by PR Automation Workflow*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Build Validation')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if build or validation failed
        if: steps.build.outputs.build_status == 'failed' || steps.validate.outputs.validation_status == 'failed'
        run: |
          echo "Build or validation failed. Please fix the issues before merging."
          exit 1
